
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Ben Straub</title>
  <meta name="author" content="Ben Straub">

  
  <meta name="description" content="libgit2: Walking History (unpublished) Oct 2nd, 2013 Making new commits and dealing with the working directory is only half of what git is for.
Most &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ben.github.com/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Ben Straub" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-35858797-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body >
  <header role="banner" id="sidebar">
    <!-- Logo -->
<ul id="menu">

  <li class="title">
    <h1 id="title"><a href="/">Ben Straub</a></h1>
  </li>


  <li class="link">
    <a href="/about">who?</a>
  </li>
  <li class="link">
    <a href="/talks">talks</a>
  </li>

  <li class="link">
    <a href="http://twitter.com/benstraub/">twitter</a>
  </li>


  <li class="link">
    <a href="http://github.com/ben/">github</a>
  </li>

  <li class="link rss">
    <a href="/atom.xml">rss feed</a>
  </li>

  <li class="link">—</li>

  <li class='link'><a class='category' href='/blog/categories/libgit2/'>libgit2</a></li>

</ul>



<!-- Octopress Love -->
<aside id="octopress_linkback">
  <a href="http://octopress.org/">
    <span class="unicode_square">
      <span class="unicode_circle">
        &nbsp;
      </span>
    </span>
    <span class="octopress">Powered by Octopress</span>
  </a>
</aside>

  </header>
  <section id="main">
      
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2013/10/02/revwalk/">libgit2: Walking History</a>
        
        <span style="color: #aaa">(unpublished)</span>
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-02T12:21:00-07:00" pubdate data-updated="true">Oct 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <p>Making new commits and dealing with the working directory is only half of what git is for.
Most of the data in a git repository is historical; old commits, old versions of files.
Let&#8217;s take a look at how you can use libgit2 to handle that information.</p>

<h2>Commits</h2>

<p>It&#8217;s pretty easy to just load up a commit and start poking around with the data inside it.
It seems pretty logical to do this when you want to walk the commit history of the project, right?
Let&#8217;s take a look at how that turns out:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'>  <span class="kt">void</span> <span class="nf">visit</span><span class="p">(</span><span class="n">git_commit</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">ize_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">num_parents</span> <span class="o">=</span> <span class="n">git_commit_parentcount</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>

    <span class="cm">/* Print some stuff about this commit */</span>
    <span class="kt">char</span> <span class="n">oidstr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">git_oid_tostr</span><span class="p">(</span><span class="n">oidstr</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="n">git_commit_id</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oidstr</span><span class="p">,</span>
           <span class="n">commit_message</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">num_parents</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
      <span class="cm">/* Do the same for the parents */</span>
      <span class="n">git_commit</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">git_commit_parent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
        <span class="n">visit</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
      <span class="n">git_commit_free</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="n">git_commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">;</span>
  <span class="cm">/* elided: dereference HEAD to a commit */</span>
  <span class="n">visit</span><span class="p">(</span><span class="n">commit</span><span class="p">);</span>
</code></pre></div></figure>


<p>But what if you want something other than a depth-first traversal?
Maybe you want to sort the results by commit time?
That&#8217;s a pretty tricky bit of code to write.
What if your repo has a non-trivial amount of history?
You&#8217;ll run out of stack frames pretty quickly.</p>

<p>There&#8217;s an API for that.</p>

<h2>Revwalk</h2>

<p>The revwalk API works similarly to what we just wrote above, with a few exceptions:</p>

<ul>
<li>It has a configurable sort order for the output.</li>
<li>It&#8217;s not built on recursion, so even very large repos can be walked efficiently.</li>
<li>You get to choose your start and end points.</li>
<li>It offers some history simplification.</li>
</ul>


<p>Let&#8217;s walk through this one step at a time.
First, you have to create a walker object:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'>  <span class="n">git_revwalk</span> <span class="o">*</span><span class="n">walk</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">git_revwalk_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">walk</span><span class="p">,</span> <span class="n">repo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">{</span> <span class="cm">/* ERROR */</span> <span class="p">}</span>
</code></pre></div></figure>


<p>Pretty straightforward, not much to explain here.
Next, let&#8217;s configure the walk:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'>  <span class="n">git_revwalk_sorting</span><span class="p">(</span><span class="n">walk</span><span class="p">,</span>
    <span class="n">GIT_SORT_TOPOLOGICAL</span> <span class="o">|</span>
    <span class="n">GIT_SORT_TIME</span><span class="p">)</span>
  <span class="n">git_revwalk_push_head</span><span class="p">(</span><span class="n">walk</span><span class="p">);</span>
  <span class="n">git_revwalk_hide_glob</span><span class="p">(</span><span class="n">walk</span><span class="p">,</span> <span class="s">&quot;tags/*&quot;</span><span class="p">);</span>

  <span class="n">git_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
  <span class="n">git_revparse_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="s">&quot;HEAD~10&quot;</span><span class="p">);</span>
  <span class="n">git_revwalk_hide</span><span class="p">(</span><span class="n">walk</span><span class="p">,</span> <span class="n">git_object_id</span><span class="p">(</span><span class="n">obj</span><span class="p">));</span>
  <span class="n">git_object_free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</code></pre></div></figure>


<p>We&#8217;re doing several things here:</p>

<ol>
<li>We set the sort order to &#8220;topological + time&#8221;.
This sounds a bit arcane, but it&#8217;s just what you&#8217;d want for a log viewer: parents after children, sorted by commit time.</li>
<li>We &#8220;push&#8221; the HEAD commit onto the walk.
This tells the walk that the HEAD and its ancestors should be visited when we start iterating.
You can even do more than one &#8220;push&#8221; (i.e. all of the known refs, for behavior like <code>git log --all</code>).</li>
<li>We &#8220;hide&#8221; from the walk all commits that are included in a tag.
The pattern will match all the refs under &#8220;refs/tags&#8221;, dereference them to commits, and exclude those commits and their ancestors from the walk.</li>
<li>We also hide all commits that precede the 10th ancestor of HEAD.
This has much the same effect as passing <code>-10</code> to <code>git log</code>.</li>
</ol>


<p>Obviously, these particular choices won&#8217;t be right for every application, but there are more than enough options to (hopefully) fit your use case.
And if not, you can always fall back to writing your own walk using the commit API.</p>

<p>Now we&#8217;re ready to run the walk, and print out some facts about each commit:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'>  <span class="n">git_oid</span> <span class="n">oid</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">git_revwalk_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span> <span class="n">walk</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">git_commit</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">oidstr</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

    <span class="n">git_commit_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oid</span><span class="p">);</span>
    <span class="n">git_oid_tostr</span><span class="p">(</span><span class="n">oidstr</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oid</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">%s</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oidstr</span><span class="p">,</span>
           <span class="n">git_commit_message</span><span class="p">(</span><span class="n">c</span><span class="p">));</span>

    <span class="n">git_commit_free</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
  <span class="p">}</span>
</code></pre></div></figure>


<p><em>[Implementing <code>--graph</code> is left as an exercise for the reader.]</em></p>

<p>That wasn&#8217;t so bad, was it?
Traveling through time was never so easy.
All that&#8217;s left is to clean up the mess we&#8217;ve made.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'>  <span class="n">git_repository_free</span><span class="p">(</span><span class="n">repo</span><span class="p">);</span>
</code></pre></div></figure>


<h2>What now?</h2>

<p>I dunno.
What are you trying to do?
You could always check out my <a href="/blog/categories/libgit2/">other libgit2 posts</a> for some ideas.
Or look for help <a href="https://www.google.com/search?q=how%20do%20I%20use%20libgit2%20to">everywhere else</a>.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2013/09/03/breaking-up-the-day/">Breaking Up the Day</a>
        
        
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-03T08:17:00-07:00" pubdate data-updated="true">Sep 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <p>I&#8217;ve always had a pretty loose attitude towards how I work.
I&#8217;d wake up, feed and take the kids to school, and just <em>go</em>.
When you work at GitHub and you really only have one project, it&#8217;s pretty easy to sink your teeth in and forget all the other stuff.</p>

<p>The thing is, that &#8220;other stuff&#8221; is important.
Bills that need paid on time, car maintenance, grocery shopping, banking.
That stuff was getting dropped way too often, things that deserved attention got none, and we paid late fees.
Part of the deal with my wife and I both working from home is that we divide up the household work, and my bits weren&#8217;t getting taken care of.
I&#8217;m sick of always feeling behind, and like I&#8217;m failing.</p>

<p>So starting today I&#8217;m changing it.</p>

<h2>The Schedule</h2>

<p>My day needs more structure.
Things that are important but not fun need to have a procrastination-proof method for getting attention, and I don&#8217;t want to be distracted by them when I&#8217;m trying to write code.
The answer is to more intentionally manage my focused attention.</p>

<h3>Early morning – writing</h3>

<p>My family doesn&#8217;t wake up until about 6:30, but I&#8217;ve found that getting up early and <a href="/2012/10/24/the-best-part-of-waking-up/">writing something</a> helps me have more focus for the rest of the day.
So I have a 45-60 minute block of time to get something done, and a project that needs monotonic progress.
Perfect!</p>

<h3>Before lunch - work before play</h3>

<p>Once the kids are fed and at school, and I get back from the gym, there are three things I <strong>must</strong> clear out before I sink into coding:</p>

<ol>
<li>Household inbox</li>
<li>Personal journal</li>
<li>Work inbox</li>
</ol>


<p>These are the things that distract or annoy me, and the things that need to get done that aren&#8217;t.
Having an empty inbox just feels good, like a real accomplishment, rather than yet another day at the sisyphean grind.</p>

<p>I have to have a strategy for things that arrive, though.
Things that are seriously urgent can override the other stuff I&#8217;m working on, but it has to have a enough <a href="http://www.mindtools.com/pages/article/newHTE_91.htm">urgency and importance</a> to displace the work I&#8217;m already doing.
Anything that can wait until the next morning, should.</p>

<p>This is bigger than it sounds.
It takes a good 15 minutes to get into a <a href="http://psygrammer.com/2011/02/10/the-flow-programming-in-ecstasy/">flow state</a>, and any interruption can cost you all that spin-up time.
Even something so small as the mail delivery.
By corralling all these little snippy tasks into one part of the day, and keeping them out of all the others, I preserve my precious flow states without letting things slip through the cracks.</p>

<h3>After lunch - heavy focus</h3>

<p>Now that the inboxes are cleared and my attention isn&#8217;t divided, I can devote serious focus to solving code problems.
My wife also works from home, and it might be possible that we distract each other with stupid cat GIFs from time to time, but we&#8217;ve agreed that from lunch until school lets out is <em>uninterruptible time</em>.
This gives both of us a multi-hour block of focus time to get into a flow state.</p>

<h3>Evening - writing</h3>

<p>We pick up the kids from school at 4, and from then until 7 is time for being present.
Working from home presents the very real risk of never <em>leaving</em> work, so we make a conscious effort to close the office door and just hang out as a family.</p>

<p>Once the kids are asleep (bedtime is 7pm), I usually find that I have one or two more hours&#8217; worth of productive energy left.
Some nights this doesn&#8217;t happen, and my wife and I will just kick back and watch TV or read, but when I do have some gumption left, I don&#8217;t want it to go to waste.
This time is set aside for writing, and it&#8217;s usually when I do my best work.</p>

<h2>The Focus</h2>

<p>GitHub employees get to work on whatever they want, and there are always at least 10 <em>majorly interesting things</em> happening that I want to contribute to.
I&#8217;ve started to learn to say &#8220;no&#8221; to that first email notification, to unwatch the repository, to make a rational choice about whether I can help out on a project.
What I don&#8217;t want is to dabble in a hundred things, without making a single <strong>meaningful</strong> contribution to any of them.</p>

<p>So for now I&#8217;m limiting myself to one writing project, and two big software projects.
I&#8217;ve heard that it works for some people to declare Monday as &#8220;Project A Day&#8221;, Tuesday as &#8220;Project B Day&#8221;, and so on, but I don&#8217;t think that&#8217;ll work for me.
The only way to be fair to the projects I&#8217;m involved in is to be constantly available, but only shipping one thing at a time.
This means that my projects &#8220;take turns&#8221; getting a chunk of code from me.</p>

<h2>Wish me luck!</h2>

<p>This is a bit of an experiment, but isn&#8217;t everything?
I&#8217;ll check back in a month and see how it&#8217;s going.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2013/06/03/refs-tags-and-branching/">libgit2: Refs, Tags, and Branching</a>
        
        
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-03T16:00:00-07:00" pubdate data-updated="true">Jun 3<span>rd</span>, 2013</time>
        
      </p>
    
  </header>


  <p>Refs are a powerful way of annotating a git repository&#8217;s history.
Libgit2, of course, provides several ways of working with them.</p>

<h2>Refs</h2>

<p>There are several ways to get a handle on a ref in libgit2.
If you just want one:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_reference</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
<span class="n">git_reference_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="s">&quot;refs/heads/master&quot;</span><span class="p">);</span>
</code></pre></div></figure>


<p>The string argument has to be the full name of the ref; just <code>master</code> won&#8217;t do.
There&#8217;s also a shortcut to use a more humane ref name:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_reference_dwim</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="s">&quot;master&quot;</span><span class="p">);</span>
</code></pre></div></figure>


<p>That one applies the <a href="http://git-scm.com/docs/git-rev-parse.html#_specifying_revisions">standard git precedence rules</a> to figure out which ref you mean.</p>

<p>There&#8217;s also a way of getting to <em>all</em> of the refs in a repository:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="kt">int</span> <span class="nf">each_ref</span><span class="p">(</span><span class="n">git_reference</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">git_reference_name</span><span class="p">(</span><span class="n">ref</span><span class="p">));</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">git_reference_foreach</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">each_ref</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
</code></pre></div></figure>


<p>Once you have a <code>git_reference*</code>, what can you do with it? Well, you can check to see if it&#8217;s symbolic (like <code>HEAD</code> usually is) or direct (like <code>master</code> usually is):</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="k">switch</span><span class="p">(</span><span class="n">git_reference_type</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">GIT_REF_OID</span>:
  <span class="p">{</span>
    <span class="kt">char</span> <span class="n">oidstr</span><span class="p">[</span><span class="mi">41</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">git_oid_fmt</span><span class="p">(</span><span class="n">oidstr</span><span class="p">,</span> <span class="n">git_reference_target</span><span class="p">(</span><span class="n">ref</span><span class="p">));</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;It&#39;s a direct reference to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">oidstr</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">case</span> <span class="n">GIT_REF_SYMBOLIC</span>:
  <span class="p">{</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;It&#39;s a symbolic reference to &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
      <span class="n">git_reference_symbolic_target</span><span class="p">(</span><span class="n">ref</span><span class="p">));</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></figure>


<p>You can change its target, which <a href="/2013/04/02/libgit2-checkout/">in combination with <code>git_checkout_head</code></a> would get close to the branch-switching behavior of <code>git checkout</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_reference</span> <span class="o">*</span><span class="n">new_ref</span><span class="p">;</span>
<span class="n">git_reference_symbolic_set_target</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span>
                                  <span class="s">&quot;refs/heads/devel&quot;</span><span class="p">);</span>
</code></pre></div></figure>


<p>Note that a <code>git_reference</code> is conceptually immutable, so changing the target of one gives you a new instance rather than modifying the one you already have.</p>

<p>You can also create new references. This is a good start towards <code>git checkout -b</code>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_object</span> <span class="o">*</span><span class="n">obj</span><span class="p">;</span>
<span class="n">git_revparse_single</span><span class="p">(</span><span class="o">&amp;</span><span class="n">obj</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="s">&quot;master&quot;</span><span class="p">);</span>
<span class="n">git_reference_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="s">&quot;refs/heads/feature1&quot;</span><span class="p">,</span>
                     <span class="n">git_object_id</span><span class="p">(</span><span class="n">obj</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
<span class="n">git_object_free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
</code></pre></div></figure>


<h2>Tags</h2>

<p>Git tags come in two flavors: <a href="http://git-scm.com/book/en/Git-Basics-Tagging">lightweight and annotated</a>.
Lightweight tags are just regular references, so you can handle them with the refs API.
But annotated tags have structured data stored in the object database.
This is represented in libgit2 as a <code>git_tag</code> structure.</p>

<p>Again, there are several ways to get your hands on a tag annotation.
You can do a direct lookup if you know the hash of the annotation:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_oid</span> <span class="n">oid</span><span class="p">;</span>
<span class="n">git_oid_fromstr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oid</span><span class="p">,</span>
  <span class="s">&quot;bbea158ddb36042aa47ce1e4d0188684b20157d3&quot;</span><span class="p">);</span>
<span class="n">git_tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
<span class="n">git_tag_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oid</span><span class="p">);</span>
</code></pre></div></figure>


<p>If all you know is the tag&#8217;s name, it takes a couple of steps:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_reference</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
<span class="n">git_reference_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="s">&quot;refs/tags/annotated&quot;</span><span class="p">);</span>
<span class="n">git_tag</span> <span class="o">*</span><span class="n">tag</span><span class="p">;</span>
<span class="n">git_reference_peel</span><span class="p">((</span><span class="n">git_object</span><span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tag</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">GIT_OBJ_TAG</span><span class="p">);</span>
</code></pre></div></figure>


<p>What can you do with one of these guys?
Mostly they&#8217;re for inspecting properties:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="c1">// Get the full name of the tag</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">git_tag_name</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
<span class="c1">// Get the tag&#39;s message</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">git_tag_message</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
<span class="c1">// Get the targeted object&#39;s ID</span>
<span class="n">git_oid</span> <span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">git_tag_target_id</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
<span class="c1">// Get information about the tagger</span>
<span class="n">git_signature</span> <span class="o">*</span><span class="n">sig</span> <span class="o">=</span> <span class="n">git_tag_signature</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
</code></pre></div></figure>


<p>How do you create tags?
As I mentioned above, lightweight tags are just references, so you&#8217;d use <code>git_reference_create</code>, and give it a name like <code>refs/tags/foo</code>.
Annotated tags have their own creation call:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'>  <span class="n">git_signature</span> <span class="o">*</span><span class="n">sig</span><span class="p">;</span>
  <span class="n">git_signature_now</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sig</span><span class="p">,</span> <span class="s">&quot;Mr. Tagger&quot;</span><span class="p">,</span> <span class="s">&quot;mr@tagger.com&quot;</span><span class="p">);</span>
  <span class="n">git_oid</span> <span class="n">annotation_id</span><span class="p">;</span>
  <span class="n">git_tag_create</span><span class="p">(</span>
    <span class="o">&amp;</span><span class="n">annotation_id</span><span class="p">,</span>      <span class="c1">// newly-created object&#39;s id</span>
    <span class="n">repo</span><span class="p">,</span>                <span class="c1">// repository</span>
    <span class="s">&quot;new_annotated_tag&quot;</span><span class="p">,</span> <span class="c1">// tag name</span>
    <span class="n">obj</span><span class="p">,</span>                 <span class="c1">// tag target</span>
    <span class="n">sig</span><span class="p">,</span>                 <span class="c1">// signature</span>
    <span class="s">&quot;A message&quot;</span><span class="p">,</span>         <span class="c1">// message</span>
    <span class="mi">1</span><span class="p">);</span>                  <span class="c1">// force if name collides</span>
</code></pre></div></figure>


<p>It turns out an annotated tag is just a lightweight tag (regular ref) that points to a tag annotation object, which in turn points to something else.
So you can create an annotation with <code>git_tag_annotation_create</code>, then create the tag ref separately.</p>

<p>Don&#8217;t forget this is C; always free your newly-created heap objects with <code>git_*_free</code> calls.
In this case:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_signature_free</span><span class="p">(</span><span class="n">sig</span><span class="p">);</span>
<span class="n">git_object_free</span><span class="p">(</span><span class="n">obj</span><span class="p">);</span>
<span class="n">git_tag_free</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
<span class="n">git_reference_free</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
</code></pre></div></figure>


<p>The rule of thumb here is if you declared it as a pointer, it probably needs freeing.</p>

<h2>What now?</h2>

<p>I dunno.
What are you trying to do?
You could always check out my <a href="/blog/categories/libgit2/">other libgit2 posts</a> for some ideas.
Or look for help <a href="https://www.google.com/search?q=how%20do%20I%20use%20libgit2%20to">everywhere else</a>.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2013/04/02/libgit2-checkout/">libgit2: Checkout</a>
        
        
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-02T10:43:00-07:00" pubdate data-updated="true">Apr 2<span>nd</span>, 2013</time>
        
      </p>
    
  </header>


  <p>So you&#8217;ve got this <a href="/2013/03/05/libgit2-the-repository">git repository</a>, and it&#8217;s got a bunch of stuff in it &#8211; refs, trees, blobs, commits &#8211; and you want to work with that stuff.
One way to think about that stuff is by thinking about how it&#8217;s organized into <a href="http://git-scm.com/2011/07/11/reset.html">three trees</a>, and moving stuff between those trees.
In libgit2, the way you get stuff from a commit into the index and the working tree is by using the checkout API.</p>

<h2>This isn&#8217;t &#8221;<code>git checkout</code>&#8221;</h2>

<p>The first thing to realize is that libgit2 isn&#8217;t just a reimplementation of the git command line tool.
That means that some terminology is reused, but doesn&#8217;t necessarily work the same way.
In libgit2, checkout is all about modifying the index and/or working directory, based on content from the index or a tree in the object database.</p>

<p>Libgit2&#8217;s checkout API has (as of this writing) three modes:</p>

<ul>
<li><code>git_checkout_head</code> updates the index and working tree to match the content of the tree pointed to by <code>HEAD</code>.</li>
<li><code>git_checkout_index</code> updates the working directory to match the content of the index.</li>
<li><code>git_checkout_tree</code> updates the working directory to the content of a specified tree.</li>
</ul>


<p>None of those deal with actually moving <code>HEAD</code> around, which is most of what I use <code>git checkout</code> for, but hey.
If you want to move refs around, try the refs API.</p>

<h2>Wholesale</h2>

<p>The general form for calling a checkout API is this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_repository</span> <span class="o">*</span><span class="n">repo</span><span class="p">;</span>
<span class="n">git_checkout_opts</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">GIT_CHECKOUT_OPTS_INIT</span><span class="p">;</span>
<span class="c1">// customize options...</span>
<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">git_checkout_head</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
</code></pre></div></figure>


<p>That <code>opts</code> structure is where all the good stuff happens.
The default mode of operation is to</p>

<ol>
<li>Check every file in the tree that&#8217;s being read for differences with the index and/or working directory, and</li>
<li>do absolutely nothing to the working directory.</li>
</ol>


<p>By design, you have to be very explicit when you&#8217;re writing stuff to the working directory.
To specify what strategy you want the checkout to use, you modify <code>opts.checkout_strategy</code>, usually to one of these values:</p>

<ul>
<li><code>GIT_CHECKOUT_SAFE</code> will update files that match what&#8217;s in the index (files that haven&#8217;t been changed), but won&#8217;t create missing files.</li>
<li><code>GIT_CHECKOUT_SAFE_CREATE</code> does the above plus creating missing files. This is what <a href="/2013/02/01/stupid-libgit2-tricks-cloning"><code>git_clone</code></a> uses by default.</li>
<li><code>GIT_CHECKOUT_FORCE</code> does the above, plus overwriting uncommitted changes.
This is the most like <code>git checkout -f</code>.</li>
</ul>


<p>There are some other behavior flags you can include in this field as well:</p>

<ul>
<li><code>GIT_CHECKOUT_ALLOW_CONFLICTS</code> allows the checkout to proceed even if there are unresolved merge conflicts (the default is to return an error if any are present).</li>
<li><code>GIT_CHECKOUT_REMOVE_UNTRACKED</code> removes files that aren&#8217;t being tracked by git (but doesn&#8217;t touch ignored files).</li>
<li><code>GIT_CHECKOUT_REMOVE_IGNORED</code> removes ignored files that aren&#8217;t in the index (but doesn&#8217;t touch non-ignored files that are untracked).</li>
</ul>


<p>That&#8217;s just a sampling; the <a href="https://github.com/libgit2/libgit2/blob/HEAD/include/git2/checkout.h#files">header comments</a>, are pretty helpful for using the rest.</p>

<h2>Progress and notification callbacks</h2>

<p>The <code>git_checkout_*</code> calls are blocking.
If you want to know how things are going, or display progress to the user, you have to register callbacks.
There are two types.</p>

<h3>Progress</h3>

<p>The progress callback notifies you as checkout actually writes files to the working directory.
Here&#8217;s how one might look:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="k">static</span> <span class="kt">void</span> <span class="nf">checkout_progress</span><span class="p">(</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
  <span class="kt">size_t</span> <span class="n">current</span><span class="p">,</span>
  <span class="kt">size_t</span> <span class="n">total</span><span class="p">,</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;checkout: %3d%% - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
    <span class="mi">100</span><span class="o">*</span><span class="n">current</span><span class="o">/</span><span class="n">total</span><span class="p">,</span>
    <span class="n">path</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// ...</span>
<span class="n">git_checkout_opts</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">GIT_CHECKOUT_OPTS_INIT</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">progress_cb</span> <span class="o">=</span> <span class="n">checkout_progress</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">git_checkout_head</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
</code></pre></div></figure>


<p>The output looks something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='text'>checkout:   0% - (null)
checkout:  12% - a/a1
checkout:  25% - a/a1.txt
checkout:  37% - a/a2.txt
checkout:  50% - b/b1.txt
checkout:  62% - b/b2.txt
checkout:  75% - c/c1.txt
checkout:  87% - c/c2.txt
checkout: 100% - master.txt
</code></pre></div></figure>


<h3>&#8220;Notifications&#8221;</h3>

<p>The other callback you can specify is more specific about what&#8217;s going on with the files in the working directory.
Checkout actually uses diff to do its work, so it doesn&#8217;t always overwrite every file in the working directory.
If the contents match, no work is done at all.
That little bit of understanding might make it easier to see this callback in action:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="k">static</span> <span class="kt">int</span> <span class="nf">checkout_notify_cb</span><span class="p">(</span>
  <span class="n">git_checkout_notify_t</span> <span class="n">why</span><span class="p">,</span>
  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">git_diff_file</span> <span class="o">*</span><span class="n">baseline</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">git_diff_file</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
  <span class="k">const</span> <span class="n">git_diff_file</span> <span class="o">*</span><span class="n">workdir</span><span class="p">,</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;path &#39;%s&#39; - &quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
  <span class="k">switch</span> <span class="p">(</span><span class="n">why</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">case</span> <span class="n">GIT_CHECKOUT_NOTIFY_CONFLICT</span>:
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;conflict</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">GIT_CHECKOUT_NOTIFY_DIRTY</span>:
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;dirty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">GIT_CHECKOUT_NOTIFY_UPDATED</span>:
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;updated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">GIT_CHECKOUT_NOTIFY_UNTRACKED</span>:
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;untracked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="k">case</span> <span class="n">GIT_CHECKOUT_NOTIFY_IGNORED</span>:
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="nl">default:</span>
  <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// ...</span>
<span class="n">git_checkout_opts</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">GIT_CHECKOUT_OPTS_INIT</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">checkout_strategy</span> <span class="o">=</span> <span class="n">GIT_CHECKOUT_SAFE</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">notify_flags</span> <span class="o">=</span>
  <span class="n">GIT_CHECKOUT_NOTIFY_CONFLICT</span> <span class="o">|</span>
  <span class="n">GIT_CHECKOUT_NOTIFY_DIRTY</span> <span class="o">|</span>
  <span class="n">GIT_CHECKOUT_NOTIFY_UPDATED</span> <span class="o">|</span>
  <span class="n">GIT_CHECKOUT_NOTIFY_UNTRACKED</span> <span class="o">|</span>
  <span class="n">GIT_CHECKOUT_NOTIFY_IGNORED</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">notify_cb</span> <span class="o">=</span> <span class="n">checkout_notify_cb</span><span class="p">;</span>
<span class="n">git_checkout_head</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
</code></pre></div></figure>


<p>Here&#8217;s some example output.
I&#8217;ve created the <code>.gitignore</code> file so that <code>foo</code> will be ignored, and changed the contents of <code>master.txt</code>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='text'>path &#39;.gitignore&#39; - untracked
path &#39;a/a1.txt&#39; - dirty
path &#39;foo&#39; - ignored
checkout:   0% - (null)
</code></pre></div></figure>


<p>I&#8217;ve left the progress callback as-is, so you can see how these two features interact &#8211; notifications happen as checkout is <em>determining what to do</em>, and progress callbacks happen as checkout is <em>doing the things</em>.</p>

<p>That&#8217;s when the checkout strategy is set to <code>GIT_CHECKOUT_SAFE_CREATE</code>.
Watch what happens when I change it to this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">opts</span><span class="p">.</span><span class="n">checkout_strategy</span> <span class="o">=</span>
  <span class="n">GIT_CHECKOUT_FORCE</span> <span class="o">|</span>
  <span class="n">GIT_CHECKOUT_REMOVE_UNTRACKED</span><span class="p">;</span>
</code></pre></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='text'>path &#39;.gitignore&#39; - untracked
path &#39;a/a1.txt&#39; - dirty
path &#39;a/a1.txt&#39; - updated
path &#39;foo&#39; - ignored
checkout:   0% - (null)
checkout:  50% - .gitignore
checkout: 100% - a/a1.txt
</code></pre></div></figure>


<p>You can see that <code>a/a1.txt</code> was updated in the index, and if we had specified a progress callback, you&#8217;d see it being written in the working directory.</p>

<p>We also asked checkout to remove untracked files (but not ignored ones), so it deleted the <code>.gitignore</code> file, leaving <code>foo</code> as untracked instead of ignored.
If we run it again:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='text'>path &#39;foo&#39; - untracked
checkout:   0% - (null)
checkout: 100% - foo
</code></pre></div></figure>


<p>&#8230; it removes the <code>foo</code> file as well.</p>

<p>One other capability that the notification callback gives you is <em>the ability to cancel the checkout</em> before any changes have been written to disk.
Just return something other than <code>0</code>, and the process will simply be aborted.</p>

<h2>One file at a time</h2>

<p>What if you don&#8217;t want to check out the entire working directory?
What if you just want to discard the changes made to one file?
The options structure has a field for you &#8211; it&#8217;s named <code>paths</code>, and it&#8217;s of type <code>git_strarray</code>.</p>

<p>Despite the name, it&#8217;s actually an array of fnmatch-patterns, like <code>"foo/*"</code> &#8211; the same format as you&#8217;d use in a <code>.gitignore</code> file.
Continuing our earlier example, if I wanted to limit the files checkout is looking at to just the files in the <code>a</code> directory, I could do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="kt">char</span> <span class="o">*</span><span class="n">paths</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;a/*&quot;</span> <span class="p">};</span>
<span class="n">opts</span><span class="p">.</span><span class="n">paths</span><span class="p">.</span><span class="n">strings</span> <span class="o">=</span> <span class="n">paths</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">paths</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</code></pre></div></figure>


<p>And the output would look something like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='text'>path &#39;a/a1.txt&#39; - dirty
path &#39;a/a1.txt&#39; - updated
checkout:   0% - (null)
checkout: 100% - a/a1.txt
</code></pre></div></figure>


<p>Note there&#8217;s no mention of <code>.gitignore</code> or <code>foo</code>; they&#8217;re filtered out by path matching before any of the diff logic is even applied.</p>

<h2>Not <code>HEAD</code></h2>

<p>All of the examples we&#8217;ve seen so far use <code>git_checkout_head</code>.
What if you want to pull out content that isn&#8217;t from <code>HEAD</code>?
We saw in the beginning that you can easily pull content out of the index by doing this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_checkout_index</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
</code></pre></div></figure>


<p>This gets content from the index and writes it to the working directory.
It&#8217;s similar to doing <code>git checkout [file]</code> without specifying a branch or revision.
That <code>NULL</code> parameter could also refer to a separate index, which is a bit beyond the scope of this post.</p>

<p>You can also pull content from elsewhere in the history.
For instance, to replicate something like <code>git checkout HEAD~~ master.txt</code>, you could do this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="kt">char</span> <span class="o">*</span><span class="n">paths</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="s">&quot;master.txt&quot;</span><span class="p">};</span>
<span class="n">opts</span><span class="p">.</span><span class="n">paths</span><span class="p">.</span><span class="n">strings</span> <span class="o">=</span> <span class="n">paths</span><span class="p">;</span>
<span class="n">opts</span><span class="p">.</span><span class="n">paths</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">// Get &quot;HEAD~~&quot;</span>
<span class="n">git_commit</span> <span class="o">*</span><span class="n">commit</span><span class="p">;</span>
<span class="n">git_revparse_single</span><span class="p">((</span><span class="n">git_object</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">commit</span><span class="p">,</span> <span class="n">repo</span><span class="p">,</span> <span class="s">&quot;HEAD~~&quot;</span><span class="p">);</span>

<span class="c1">// Do the checkout</span>
<span class="n">git_checkout_tree</span><span class="p">(</span><span class="n">repo</span><span class="p">,</span> <span class="n">commit</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>

<span class="c1">// Clean up</span>
<span class="n">git_commit_free</span><span class="p">(</span><span class="n">commit</span><span class="p">);</span>
</code></pre></div></figure>


<h2>That&#8217;s about it</h2>

<p><strong>NOTE: You should do error checking.</strong>
You should also check out the documentations comments in the <a href="https://github.com/libgit2/libgit2/blob/HEAD/include/git2/checkout.h#files"><code>git2/checkout.h</code></a> header &#8211; they&#8217;re really well-written, and they cover more than what I&#8217;ve got here.</p>

<h2>What now?</h2>

<p>I dunno.
What are you trying to do?
You could always check out my <a href="/blog/categories/libgit2/">other libgit2 posts</a> for some ideas.
Or look for help <a href="https://www.google.com/search?q=how%20do%20I%20use%20libgit2%20to">everywhere else</a>.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2013/03/05/libgit2-the-repository/">libgit2: The Repository</a>
        
        
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-05T12:00:00-08:00" pubdate data-updated="true">Mar 5<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <p>In <a href="http://libgit2.github.com/">libgit2</a>, the <code>git_repository</code> object is the gateway to getting interesting stuff out of git.
There are several ways to get your hands on one.</p>

<h2>Clone</h2>

<p>If your repository exists on a remote but not on the local machine, you can get it using <a href="http://libgit2.github.com/libgit2/#HEAD/group/repository/git_clone"><code>git_clone</code></a>, and once it&#8217;s done with all the network stuff, it spits out a repository object.
Check out <a href="/2013/02/01/stupid-libgit2-tricks-cloning/">my post on cloning</a> for more on that.</p>

<h2>Discover</h2>

<p>If you know a particular directory is a git repository, you can just hand the path to <a href="http://libgit2.github.com/libgit2/#HEAD/group/repository/git_repository_open"><code>git_repository_open</code></a>.
The path can be to a bare repository, a <code>.git</code> folder, or a working directory.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_repository</span> <span class="o">*</span><span class="n">repo</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">git_repository_open</span><span class="p">(</span>
  <span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span>
  <span class="s">&quot;/path/to/repository/on/disk&quot;</span><span class="p">);</span>
</code></pre></div></figure>


<p>In classic C fashion, libgit2 APIs generally return 0 on success, and a negative error code on failure.
Occasionally the API documentation will mention the specific error codes that will come back, but you can always check the <a href="https://github.com/libgit2/libgit2/blob/HEAD/include/git2/errors.h#files">error header</a> for the values.</p>

<p>If all you have is a path that you <em>think</em> is controlled by git, you can let libgit2 walk the directory structure to find it&#8217;s owning repository (if there is one).
This approach works well if your application is dealing primarily with documents, like a text editor.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="mi">1024</span><span class="p">];</span>
<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">git_repository_discover</span><span class="p">(</span>
  <span class="n">path</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span>                       <span class="c1">// buffer &amp; size</span>
  <span class="s">&quot;/path/to/a/controlled/file.md&quot;</span><span class="p">,</span>  <span class="c1">// where to start</span>
  <span class="nb">true</span><span class="p">,</span>                             <span class="c1">// across filesystems?</span>
  <span class="s">&quot;/path&quot;</span><span class="p">))</span>                         <span class="c1">// where to stop</span>
<span class="p">{</span>
  <span class="n">git_repository</span> <span class="o">*</span><span class="n">repo</span><span class="p">;</span>
  <span class="n">error</span> <span class="o">=</span> <span class="n">git_repository_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></figure>


<h2>Initialize</h2>

<p>If you want to create a new repository, <a href="http://libgit2.github.com/libgit2/#HEAD/group/repository/git_repository_init"><code>git_repository_init</code></a> is the call for you.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_repository</span> <span class="o">*</span><span class="n">repo</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">git_repository_init</span><span class="p">(</span>
  <span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span>                <span class="c1">// output</span>
  <span class="s">&quot;path/to/new/repo&quot;</span><span class="p">,</span>   <span class="c1">// path</span>
  <span class="nb">false</span><span class="p">);</span>               <span class="c1">// bare?</span>
</code></pre></div></figure>


<p>This is kind of like running <code>git init</code> from the command line.
If you need more control, you&#8217;ll use <a href="http://libgit2.github.com/libgit2/#HEAD/group/repository/git_repository_init_ext"><code>git_repository_init_ext</code></a>:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="n">git_repository</span> <span class="o">*</span><span class="n">repo</span><span class="p">;</span>
<span class="n">git_repository_init_options</span> <span class="n">options</span> <span class="o">=</span>
  <span class="n">GIT_REPOSITORY_INIT_OPTIONS_INIT</span><span class="p">;</span>
<span class="c1">// ... (configure options)</span>
<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="n">git_repository_init_ext</span><span class="p">(</span>
  <span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span>                <span class="c1">// output</span>
  <span class="s">&quot;/path/to/new/repo&quot;</span><span class="p">,</span>  <span class="c1">// path</span>
  <span class="o">&amp;</span><span class="n">options</span><span class="p">);</span>            <span class="c1">// options</span>
</code></pre></div></figure>


<p>The signature itself looks similar to the simpler version, but that options structure exposes <strong>lots</strong> of behavior.
Things like:</p>

<ul>
<li>separating your <code>.git</code> directory from the workdir</li>
<li>adding a description or using a template</li>
<li>setting the initial branch name</li>
</ul>


<p>Unfortunately, as of this writing the documentation parser doesn&#8217;t output structure-field comment-docs, but the <a href="https://github.com/libgit2/libgit2/blob/HEAD/include/git2/repository.h#files">header</a> is pretty helpful.</p>

<h2>What now?</h2>

<p>I dunno.
What are you trying to do?
You could always check out my <a href="/blog/categories/libgit2/">other libgit2 posts</a> for some ideas.
Or look for help <a href="https://www.google.com/search?q=how%20do%20I%20use%20libgit2%20to">everywhere else</a>.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2013/02/01/stupid-libgit2-tricks-cloning/">libgit2: Cloning</a>
        
        
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-01T10:00:00-08:00" pubdate data-updated="true">Feb 1<span>st</span>, 2013</time>
        
      </p>
    
  </header>


  <p><a href="http://libgit2.github.com">Libgit2</a> aims to make it easy to do interesting things
with git.  What&#8217;s the first thing you always do when learning git?  That&#8217;s
right, you clone something from GitHub.  Let&#8217;s get started, shall we? Let&#8217;s get
some of the boilerplate out of the way:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="cp">#include &quot;git2.h&quot;</span>
<span class="cp">#include &lt;stdio.h&gt;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">argv</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="o">*</span><span class="n">path</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">argc</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">printf</span><span class="p">(</span><span class="s">&quot;USAGE: clone &lt;url&gt; &lt;path&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">url</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
    <span class="k">return</span> <span class="n">do_clone</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></figure>


<p>What does the do_clone method look like?  Let&#8217;s start simple:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="k">static</span> <span class="kt">int</span> <span class="nf">do_clone</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">git_repository</span> <span class="o">*</span><span class="n">repo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">git_clone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">git_repository_free</span><span class="p">(</span><span class="n">repo</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></figure>


<p><code>git_clone</code> takes some information, and fills in a pointer for us with
a <code>git_repository</code> object we can use to do <em>all manner of unholy things</em>.  For
now, let&#8217;s ignore the repository itself, except to be good citizens and release
the memory associated with it.</p>

<p>That <code>NULL</code> parameter?  That&#8217;s for a <code>git_clone_options</code> structure, which
defaults to some sensible stuff.  The way our code is written right now, these
two commands will have the same results:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='sh'>./clone http://github.com/libgit2/libgit2 ./libgit2
git clone http://github.com/libgit2/libgit2
</code></pre></div></figure>


<p>&#8230; except that <code>git</code> tells you what it&#8217;s doing.  Let&#8217;s fix that.</p>

<p>One of the things you can do with <code>git_clone_options</code> is have libgit2 call
a function when there is progress to report.  A typical callback looks like
this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="k">static</span> <span class="kt">void</span> <span class="nf">fetch_progress</span><span class="p">(</span>
        <span class="k">const</span> <span class="n">git_transfer_progress</span> <span class="o">*</span><span class="n">stats</span><span class="p">,</span>
        <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">fetch_percent</span> <span class="o">=</span>
        <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">received_objects</span><span class="p">)</span> <span class="o">/</span>
        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">total_objects</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">index_percent</span> <span class="o">=</span>
        <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">indexed_objects</span><span class="p">)</span> <span class="o">/</span>
        <span class="n">stats</span><span class="o">-&gt;</span><span class="n">total_objects</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">kbytes</span> <span class="o">=</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">received_bytes</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">;</span>

    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;network %3d%% (%4d kb, %5d/%5d)  /&quot;</span>
            <span class="s">&quot;  index %3d%% (%5d/%5d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
            <span class="n">fetch_percent</span><span class="p">,</span> <span class="n">kbytes</span><span class="p">,</span>
            <span class="n">stats</span><span class="o">-&gt;</span><span class="n">received_objects</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">total_objects</span><span class="p">,</span>
            <span class="n">index_percent</span><span class="p">,</span>
            <span class="n">stats</span><span class="o">-&gt;</span><span class="n">indexed_objects</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">total_objects</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></figure>


<p>That <code>stats</code> object gives you lots of useful stuff:</p>

<ul>
<li>The number of objects transferred over the network</li>
<li>The number of objects that the indexer has processed</li>
<li>The total number of objects expected</li>
<li>The number of bytes transferred</li>
</ul>


<p>So let&#8217;s rewrite our <code>do_clone</code> function to plug that in:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c'><span class="k">static</span> <span class="kt">int</span> <span class="nf">do_clone</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">url</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">path</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">git_repository</span> <span class="o">*</span><span class="n">repo</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">git_clone_options</span> <span class="n">opts</span> <span class="o">=</span> <span class="n">GIT_CLONE_OPTIONS_INIT</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">opts</span><span class="p">.</span><span class="n">fetch_progress_cb</span> <span class="o">=</span> <span class="n">fetch_progress</span><span class="p">;</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">git_clone</span><span class="p">(</span><span class="o">&amp;</span><span class="n">repo</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">opts</span><span class="p">);</span>
    <span class="n">git_repository_free</span><span class="p">(</span><span class="n">repo</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></figure>


<p>If you run this now, the program will tell you what it&#8217;s doing!  You can watch
the network transfer happening, and notice that the indexer is doing its job
<em>at the same time</em>.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='text'>[...]
network  73% (   7 kb,    51/   69)  /  index  71% (   49/   69)
network  75% (   7 kb,    52/   69)  /  index  72% (   50/   69)
network  76% (   7 kb,    53/   69)  /  index  73% (   51/   69)
network  78% (   7 kb,    54/   69)  /  index  75% (   52/   69)
[...]
</code></pre></div></figure>


<p>If you try this with a large repository, you&#8217;ll notice a significant pause at
the end.  All the data has been moved, what&#8217;s going on?  It turns out that
doing a checkout can take a non-trivial amount of time.  It also turns out that
libgit2 will let you report that progress as well!</p>

<p>But that&#8217;s part of checkout, which warrants its own blog post.  In the
meantime, check out the <a href="https://github.com/libgit2/libgit2/blob/development/include/git2/clone.h">clone
header</a>
to see what <code>git_clone</code> can do.  If you want to, you could even use the <a href="https://gist.github.com/4693571">code
from this post</a> as a starting point for your
own experiments.</p>

<h2>What now?</h2>

<p>I dunno.
What are you trying to do?
You could always check out my <a href="/blog/categories/libgit2/">other libgit2 posts</a> for some ideas.
Or look for help <a href="https://www.google.com/search?q=how%20do%20I%20use%20libgit2%20to">everywhere else</a>.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2013/01/10/year-in-review/">2012: Year in Review</a>
        
        
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-10T22:28:00-08:00" pubdate data-updated="true">Jan 10<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <p>My 2012, through the GitHub lens.  Inspired by <a href="https://github.com/blog/1360-introducing-contributions">Tim Clem</a>.</p>

<p><a href="/images/contributions-2012.png"><img src="/images/contributions-2012.png" alt="Annotated GitHub Contributions Chart" /></a></p>

<p>I guess it&#8217;s not that surprising, but vacations, travel, and holidays show up pretty clearly.</p>

<p>Yes, there are two honeymoons.  Both of them piggybacked on business travel &#8212; the first was a <a href="http://www.beckyjenson.com/2012/06/hawaiian-simplicity/">destination wedding</a> I photographed with my lovely wife a week after we were married, and the second was glued to a <a href="http://www.openblend.org/en/home">conference</a> I <a href="/talks/openblend.html">spoke at</a>.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2012/10/24/the-best-part-of-waking-up/">The Best Part of Waking Up</a>
        
        <span style="color: #aaa">(unpublished)</span>
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-24T19:08:00-07:00" pubdate data-updated="true">Oct 24<span>th</span>, 2012</time>
        
      </p>
    
  </header>


  <p>It seems like such a small detail: what&#8217;s the first thing you do when you wake
up?  Hop in the shower?  Check your email?  Hit Reddit for a <a href="http://aww.reddit.com/">quick puppy
fix</a> before the coffee starts working?</p>

<p>I recently switched to writing code.</p>

<h2>Setting the tone</h2>

<p>You wake up each day completely fresh.  It takes a while before all the worries
from yesterday make themselves known again, so for a while you have an empty,
clear mind.  And the first thing you put in is going to stick.</p>

<p>I used to read email, Twitter, and Facebook first thing in the morning.  That
got me current with what happened while I was asleep, but it put me in the
mindset of keeping up.  <em>Following</em>.  From that point on, I had to know what
was going on, and since people are constantly doing things, I was always
behind.  I hate being behind.</p>

<h2>Mindset</h2>

<p>The write-first strategy puts you in the maker&#8217;s mindset.  You&#8217;ve made things
all day, you&#8217;ve been fixing bugs since before breakfast.</p>

<p>A read-first morning puts you in the mindset of a consumer.  You&#8217;re looking to
<em>be</em> entertained, always out for that next endorphin hit.  Not only does this
reduce your output, it <a href="http://devburner.net/2012/07/the-1-thing-that-will-destroy-your-creativity-in-the-morning/">kills your creativity</a>.</p>

<p>I&#8217;ve found that some of my best ideas come to me in the shower, but there needs
to be something I&#8217;m working on in that part of my mind that lurks just behind
the conscious.  If that something is &#8220;I wonder what <a href="http://daringfireball.net/">Gruber</a> is thinking
about,&#8221; I&#8217;m missing a great opportunity.  I&#8217;d much rather be solving problems.
Besides, the answer is always &#8220;Apple, or maybe baseball.&#8221;</p>

<h2>The Power of Habit</h2>

<p>We like to think of ourselves as sentient beings with free will.  This is
a pleasant fiction, with many practical benefits, but as any psychologist will
tell you, it&#8217;s not exactly true.  On any given day, it&#8217;s likely that a person
will do the same thing she did yesterday, as opposed to a completely new thing.
We&#8217;re mammals, and habit is powerful.</p>

<p>What if your habits weren&#8217;t harmful, like heroin, or merely benign, like
drinking coffee?  What if they were constructive, what if they actually made
you feel <em>better</em>?</p>

<p>It&#8217;s been working.  I feel more like a maker if, before I do anything else,
I make something.  I start checking Twitter and Facebook as break time, rather
than using them to avoiding real work, and I get more real work done.</p>

<p>It&#8217;s amazing what power a small detail can have.</p>

  
  


    </article>
  
  
    <article class="post">
      
  <header>
    
      <h1 class="entry-title">
        
        <a href="/2011/02/02/native-win32-for-fun-and-profit/">Native Win32 for fun and profit</a>
        
        <span style="color: #aaa">(unpublished)</span>
      </h1>
    
    
      <p class="meta">
        








  


<time datetime="2011-02-02T00:00:00-08:00" pubdate data-updated="true">Feb 2<span>nd</span>, 2011</time>
        
      </p>
    
  </header>


  <p><em>[Note: this is ported from my <a href="http://ben.straubnet.net/post/3074077580/native-win32-for-fun-and-profit">old
blog</a>,
and there&#8217;s more discussion there.]</em></p>

<p>All the cool kids these days are playing with awesome dynamic languages, or on
cool frameworks.  I&#8217;m stuck with c++ at work, but every now and then I get to
do something cool with it.</p>

<p><img src="/images/nativewin32/1.png" alt="radial menu" /></p>

<p>That&#8217;s the <a href="http://graphicssoft.about.com/od/hardware/ig/Wacom-Intuos4/Intuos4-Radial-Menu.htm">Wacom radial
menu</a>,
which is implemented as a fully alpha-blended window in native Win32. Something
like this is dead simple in WPF, but with native code it&#8217;s a bit trickier.
I used WTL, GDI+, and a handy, little-known Windows feature to get it done, and
I&#8217;m going to share my secrets with you, dear reader.</p>

<h2>Dependencies</h2>

<h4>WTL</h4>

<p>Windowing frameworks are thick on the ground, and I&#8217;ve been mostly dissatisfied
with the abilities of the Win32-wrapping category. However, they make something
like this reusable, so what the heck.</p>

<p>You can grab WTL at <a href="http://wtl.sourceforge.net/">the project home on
SourceForge</a>. For this project, I&#8217;m just taking
the files in the <code>include</code> directory and putting them under <code>wtl</code> in my project
directory, so I don&#8217;t get the Windows SDK versions instead.</p>

<p>I&#8217;ve found this to be the best way to include the WTL headers:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c++'><span class="cp">#define _SECURE_ATL 1</span>
<span class="cp">#define _WTL_NO_AUTOMATIC_NAMESPACE</span>
<span class="cp">#define _ATL_NO_AUTOMATIC_NAMESPACE</span>

<span class="c1">// These are required to be included first</span>
<span class="cp">#include &quot;atlbase.h&quot;</span>
<span class="cp">#include &quot;atlwin.h&quot;</span>
<span class="cp">#include &quot;wtl/atlapp.h&quot;</span>

<span class="cp">#include &quot;wtl/atlgdi.h&quot;   </span><span class="c1">// For WTL::CDC</span>
<span class="cp">#include &quot;wtl/atlframe.h&quot; </span><span class="c1">// For WTL::CFrameWindowImpl</span>
</code></pre></div></figure>


<p>Those defines specify that the ATL and WTL classes should stay safely ensconced
in their own namespaces. This means you have to reference them as
<code>WTL::CFrameWndImpl</code>, but it keeps the global namespace clean, which is a major
failing of <code>windows.h</code>.</p>

<h4>GDI+</h4>

<p>GDI+ is an immediate-mode drawing API that has shipped with Windows since XP,
so I can use it without needing to ship yet another redistributable installer.
Here&#8217;s all you need to do:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c++'><span class="cp">#pragma comment(lib, &quot;gdiplus.lib&quot;)</span>
<span class="cp">#include &amp;lt;gdiplus.h&gt;</span>
</code></pre></div></figure>


<p>While GDI+ is written in c++ and uses classes, it&#8217;s initialization isn&#8217;t
RAII-friendly, so I wrote a little wrapper class:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c++'><span class="k">class</span> <span class="nc">ScopedGdiplusInitializer</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">ScopedGdiplusInitializer</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">Gdiplus</span><span class="o">::</span><span class="n">GdiplusStartupInput</span> <span class="n">gdisi</span><span class="p">;</span>
    <span class="n">Gdiplus</span><span class="o">::</span><span class="n">GdiplusStartup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mGdipToken</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gdisi</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="o">~</span><span class="n">ScopedGdiplusInitializer</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">Gdiplus</span><span class="o">::</span><span class="n">GdiplusShutdown</span><span class="p">(</span><span class="n">mGdipToken</span><span class="p">);</span>
  <span class="p">}</span>
<span class="k">private</span><span class="o">:</span>
  <span class="n">ULONG_PTR</span> <span class="n">mGdipToken</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></figure>


<p>Now I can write my main function like this:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c++'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">ScopedGdiplusInitializer</span> <span class="n">gdiplusinit</span><span class="p">;</span>
  <span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div></figure>


<h4>Boost</h4>

<p>The production code for this feature uses boost (specifically <code>shared_ptr</code>),
but in the interest of simplicity I&#8217;ve left it out. If you use boost, or your
compiler supports the new <code>std::shared_ptr</code> introduced with TR1, I <em>highly</em>
recommend you use that instead of raw pointers whenever possible.</p>

<h2>A window class</h2>

<p>Here&#8217;s where it all comes together. Meet me after the code, and I&#8217;ll explain
more fully.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c++'><span class="k">class</span> <span class="nc">AlphaWindow</span>
  <span class="o">:</span> <span class="k">public</span> <span class="n">WTL</span><span class="o">::</span><span class="n">CFrameWindowImpl</span><span class="o">&lt;</span>
      <span class="n">AlphaWindow</span><span class="p">,</span> <span class="n">ATL</span><span class="o">::</span><span class="n">CWindow</span><span class="p">,</span>
      <span class="n">ATL</span><span class="o">::</span><span class="n">CWinTraits</span><span class="o">&lt;</span> <span class="n">WS_POPUP</span><span class="p">,</span> <span class="n">WS_EX_LAYERED</span> <span class="o">&gt;</span> <span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
  <span class="n">DECLARE_FRAME_WND_CLASS</span><span class="p">(</span><span class="n">_T</span><span class="p">(</span><span class="s">&quot;WTLAlphaWindow&quot;</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>

  <span class="k">virtual</span> <span class="o">~</span><span class="n">AlphaWindow</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">IsWindow</span><span class="p">())</span>
    <span class="p">{</span>
      <span class="n">SendMessage</span><span class="p">(</span><span class="n">WM_CLOSE</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">UpdateWithBitmap</span><span class="p">(</span><span class="n">Gdiplus</span><span class="o">::</span><span class="n">Bitmap</span> <span class="o">*</span><span class="n">bmp_I</span><span class="p">,</span>
                        <span class="n">POINT</span> <span class="o">*</span><span class="n">windowLocation_I</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// Create a memory DC</span>
    <span class="n">HDC</span> <span class="n">screenDC</span> <span class="o">=</span> <span class="o">::</span><span class="n">GetDC</span><span class="p">(</span><span class="nb">NULL</span><span class="p">);</span>
    <span class="n">WTL</span><span class="o">::</span><span class="n">CDC</span> <span class="n">memDC</span><span class="p">;</span>
    <span class="n">memDC</span><span class="p">.</span><span class="n">CreateCompatibleDC</span><span class="p">(</span><span class="n">screenDC</span><span class="p">);</span>
    <span class="o">::</span><span class="n">ReleaseDC</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">screenDC</span><span class="p">);</span>

    <span class="c1">// Copy the input bitmap and select it into the</span>
    <span class="c1">// memory DC</span>
    <span class="n">WTL</span><span class="o">::</span><span class="n">CBitmap</span> <span class="n">localBmp</span><span class="p">;</span>
    <span class="p">{</span>
      <span class="n">bmp_I</span><span class="o">-&gt;</span><span class="n">GetHBITMAP</span><span class="p">(</span><span class="n">Gdiplus</span><span class="o">::</span><span class="n">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                        <span class="o">&amp;</span><span class="n">localBmp</span><span class="p">.</span><span class="n">m_hBitmap</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">HBITMAP</span> <span class="n">oldBmp</span> <span class="o">=</span> <span class="n">memDC</span><span class="p">.</span><span class="n">SelectBitmap</span><span class="p">(</span><span class="n">localBmp</span><span class="p">);</span>

    <span class="c1">// Update the display</span>
    <span class="n">POINT</span> <span class="n">p</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
    <span class="n">SIZE</span> <span class="n">s</span> <span class="o">=</span> <span class="p">{</span><span class="n">bmp_I</span><span class="o">-&gt;</span><span class="n">GetWidth</span><span class="p">(),</span> <span class="n">bmp_I</span><span class="o">-&gt;</span><span class="n">GetHeight</span><span class="p">()};</span>
    <span class="n">BLENDFUNCTION</span> <span class="n">bf</span> <span class="o">=</span> <span class="p">{</span><span class="n">AC_SRC_OVER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="mi">255</span><span class="p">,</span> <span class="n">AC_SRC_ALPHA</span><span class="p">};</span>
    <span class="p">{</span>
      <span class="o">::</span><span class="n">UpdateLayeredWindow</span><span class="p">(</span><span class="n">m_hWnd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
                            <span class="n">windowLocation_I</span><span class="p">,</span>
                            <span class="o">&amp;</span><span class="n">s</span><span class="p">,</span> <span class="n">memDC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
                            <span class="n">RGB</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span>
                            <span class="o">&amp;</span><span class="n">bf</span><span class="p">,</span> <span class="n">ULW_ALPHA</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">ShowWindow</span><span class="p">(</span><span class="n">SW_SHOWNORMAL</span><span class="p">);</span>

    <span class="c1">// Cleanup</span>
    <span class="n">memDC</span><span class="p">.</span><span class="n">SelectBitmap</span><span class="p">(</span><span class="n">oldBmp</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></figure>


<h3>Layered Windows</h3>

<p>The magic ingredients for this class are the <code>WS_EX_*</code> styles and the
<code>UpdateLayeredWindow</code> call.</p>

<p>First, the styles. These are specified on line 3, as part of the base class.
That&#8217;s just how you declare your window&#8217;s styles in WTL. There are two:</p>

<ul>
<li><code>WS_POPUP</code> means this is a square window with no decorations around the
outside. No title bar, no close button, nothing.</li>
<li><code>WS_EX_LAYERED</code> tells Windows that <a href="http://msdn.microsoft.com/en-us/library/ms997507.aspx">this window is
different</a>, and that
it can do per-pixel alpha blending with other windows. This was available in
Windows 2000, but starting with Vista the window&#8217;s face could be cached and
composited by the GPU, which made it much more useful.</li>
</ul>


<p>The call to <code>UpdateLayeredWindow</code> on line 35 is what tells Windows what the
contents of the display are. There&#8217;s some clunky interop code here, since the
GDI+ <code>Bitmap</code> object can&#8217;t be used directly with the GDI-oriented layered
window API. I&#8217;m sure there&#8217;s a better way, but in my case the overhead of
copying my smallish <code>Bitmap</code> into another smallish <code>HBITMAP</code> wasn&#8217;t a problem.</p>

<p>WTL complains rather loudly if a window object is destroyed before the HWND
it&#8217;s wrapping is closed, so the destructor on line 7 takes care of that.</p>

<h3>Pretty Pictures</h3>

<p>That <code>UpdatedLayeredWindow</code> call is wrapped in a method that takes a GDI+
bitmap, so now all we need to do is provide it with one. GDI+ makes this pretty
easy, especially when compared to GDI code:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c++'><span class="k">using</span> <span class="k">namespace</span> <span class="n">Gdiplus</span><span class="p">;</span>
<span class="c1">// Create a bitmap buffer</span>
<span class="n">Bitmap</span> <span class="n">bmp</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">400</span><span class="p">);</span>
<span class="c1">// Context for drawing on the bitmap</span>
<span class="n">Graphics</span> <span class="n">g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="p">);</span>
<span class="n">g</span><span class="p">.</span><span class="n">Clear</span><span class="p">(</span><span class="n">Color</span><span class="o">::</span><span class="n">Black</span><span class="p">);</span>
<span class="c1">// ...</span>
</code></pre></div></figure>


<h2>All together now</h2>

<p>Here&#8217;s the <code>main</code> function of my little test program.</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><pre><code class='c++'><span class="kt">int</span> <span class="n">main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">ScopedGdiplusInitializer</span> <span class="n">init</span><span class="p">;</span>

  <span class="p">{</span>
    <span class="c1">// Create the display window</span>
    <span class="n">AlphaWindow</span> <span class="n">wnd</span><span class="p">;</span>
    <span class="n">wnd</span><span class="p">.</span><span class="n">Create</span><span class="p">();</span>
    <span class="n">wnd</span><span class="p">.</span><span class="n">SetWindowPos</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
                     <span class="n">SWP_NOSIZE</span> <span class="o">|</span> <span class="n">SWP_NOREPOSITION</span><span class="p">);</span>

    <span class="c1">// Create a backbuffer</span>
    <span class="n">Gdiplus</span><span class="o">::</span><span class="n">Bitmap</span> <span class="n">bmp</span><span class="p">(</span><span class="mi">400</span><span class="p">,</span><span class="mi">400</span><span class="p">);</span>

    <span class="c1">// Clear the background of the buffer to</span>
    <span class="c1">// translucent black</span>
    <span class="n">Gdiplus</span><span class="o">::</span><span class="n">Graphics</span> <span class="n">g</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">Clear</span><span class="p">(</span><span class="n">Gdiplus</span><span class="o">::</span><span class="n">Color</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>

    <span class="c1">// This tells GDI+ to anti-alias edges</span>
    <span class="n">g</span><span class="p">.</span><span class="n">SetSmoothingMode</span><span class="p">(</span>
       <span class="n">Gdiplus</span><span class="o">::</span><span class="n">SmoothingModeAntiAlias</span><span class="p">);</span>

    <span class="c1">// Draw two semi-transparent ellipses</span>
    <span class="n">Gdiplus</span><span class="o">::</span><span class="n">Pen</span> <span class="n">redPen</span><span class="p">(</span><span class="n">Gdiplus</span><span class="o">::</span><span class="n">Color</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                        <span class="mf">10.</span><span class="p">);</span>
    <span class="n">Gdiplus</span><span class="o">::</span><span class="n">Pen</span> <span class="n">bluePen</span><span class="p">(</span><span class="n">Gdiplus</span><span class="o">::</span><span class="n">Color</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span>
                         <span class="mf">10.</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">DrawEllipse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">redPen</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span><span class="mi">300</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">DrawLine</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bluePen</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span><span class="mi">390</span><span class="p">);</span>
    <span class="n">g</span><span class="p">.</span><span class="n">DrawEllipse</span><span class="p">(</span><span class="o">&amp;</span><span class="n">redPen</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span><span class="mi">50</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span><span class="mi">300</span><span class="p">);</span>

    <span class="c1">// Update the window&#39;s display</span>
    <span class="n">wnd</span><span class="p">.</span><span class="n">UpdateWithBitmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bmp</span><span class="p">);</span>

    <span class="c1">// Wait to exit</span>
    <span class="n">getchar</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></figure>


<p>I know, programmer demos of this are always ugly. Maybe one day I&#8217;ll write
about how to store a PNG as a resource, and load it in for use with this. For
now, you get an ugly screenshot:</p>

<p><img src="/images/nativewin32/2.png" alt="ugly test image" /></p>

  
  


    </article>
  

    <nav role="navigation" id="pagination">

</nav>
  </section>
  

  

<script type="text/javascript">
      var disqus_shortname = 'benstraubnet';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>




</body>
</html>
